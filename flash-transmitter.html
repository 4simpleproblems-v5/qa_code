<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Project Mag-Net</title>
    <style>
        :root { --bg: #00111f; --line: #00d2ff; --text: #bfefff; }
        body {
            background-color: var(--bg); color: var(--text);
            font-family: 'Courier New', monospace; margin: 0;
            display: flex; flex-direction: column; height: 100vh;
            overflow: hidden; -webkit-user-select: none;
        }

        /* NAVIGATION */
        .nav { display: flex; height: 60px; border-bottom: 1px solid #004455; }
        .nav-item {
            flex: 1; display: flex; align-items: center; justify-content: center;
            background: #001a2e; cursor: pointer; font-weight: bold; 
            border-right: 1px solid #004455; color: #447788; transition: 0.2s;
        }
        .nav-item.active { background: #002b4d; color: var(--line); border-bottom: 3px solid var(--line); }

        .view { display: none; flex: 1; flex-direction: column; align-items: center; padding: 20px; }
        .view.active { display: flex; }

        /* COMPASS VISUAL */
        #compass-ui {
            width: 200px; height: 200px; border: 2px solid #004455; border-radius: 50%;
            position: relative; margin: 20px; display: flex; align-items: center; justify-content: center;
        }
        #needle {
            width: 4px; height: 90px; background: var(--line);
            position: absolute; top: 10px; transform-origin: bottom center;
            transition: transform 0.1s;
        }
        #needle::after { content: 'N'; position: absolute; top: -20px; left: -5px; color: var(--line); }

        /* GRAPH */
        canvas {
            width: 100%; max-width: 400px; height: 100px;
            background: #000; border: 1px solid #004455; margin-top: 10px;
        }

        /* CONTROLS */
        button {
            padding: 20px; font-size: 1.1rem; font-weight: bold;
            background: var(--line); color: #000; border: none; border-radius: 4px;
            cursor: pointer; width: 100%; max-width: 300px; margin-top: 20px;
        }
        input {
            padding: 15px; background: #002b4d; border: 1px solid #005566; color: #fff;
            text-align: center; width: 100%; max-width: 300px; 
            font-family: monospace; font-size: 1.2rem;
        }

        .status { font-size: 0.9rem; color: #668899; margin-top: 10px; }
        #rx-log { font-size: 1.5rem; color: #fff; min-height: 40px; margin-top:10px; border-bottom:1px solid #333;}

    </style>
</head>
<body>

    <div class="nav">
        <div class="nav-item active" onclick="setView('tx')">SENDER (COIL)</div>
        <div class="nav-item" onclick="setView('rx')">RECEIVER (COMPASS)</div>
    </div>

    <div id="tx-view" class="view active">
        <h2 style="color:var(--line)">INDUCTION COIL</h2>
        <div style="font-size:0.8rem; text-align:center; margin-bottom:20px; color:#aaa;">
            Uses Speaker Magnet as Data Antenna.<br>
            Set Volume to MAX. Place Speaker ON Receiver Compass.
        </div>

        <input type="text" id="tx-input" value="MAG" placeholder="MSG">
        <button id="tx-btn" onclick="transmit()">ENERGIZE COIL</button>
        <div id="tx-status" class="status">Ready</div>
    </div>

    <div id="rx-view" class="view">
        <h2 style="color:var(--line)">MAGNETOMETER</h2>
        <button id="perm-btn" onclick="reqPerms()">CALIBRATE SENSORS</button>
        
        <div id="compass-ui">
            <div id="needle"></div>
        </div>

        <canvas id="scope"></canvas>
        <div class="status">Magnetic Deviation</div>

        <div id="rx-log"></div>
        <div id="rx-debug" class="status">Waiting for flux...</div>
    </div>

    <script>
        // --- CONFIG ---
        const BIT_TIME = 300; // ms per bit (Magnets are slow to settle)
        const FREQ_LOW = 20;  // 20Hz (Barely audible, high magnetic flux)
        
        function setView(v) {
            document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            document.getElementById(v+'-view').classList.add('active');
            event.target.classList.add('active');
        }

        // --- TRANSMITTER (Web Audio API) ---
        const wait = ms => new Promise(r => setTimeout(r, ms));
        let audioCtx;

        async function transmit() {
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if(audioCtx.state === 'suspended') await audioCtx.resume();

            const text = document.getElementById('tx-input').value.toUpperCase();
            const btn = document.getElementById('tx-btn');
            const stat = document.getElementById('tx-status');
            btn.disabled = true;

            // Encode to Binary
            let bits = "";
            for (let i = 0; i < text.length; i++) {
                bits += text.charCodeAt(i).toString(2).padStart(8, "0");
            }

            stat.innerText = "PILOT TONE (ALIGN NOW)...";
            playTone(true); // Continuous tone to let user align
            await wait(2000);
            playTone(false);
            await wait(500); // Silence

            stat.innerText = "TRANSMITTING...";
            
            for(let i=0; i<bits.length; i++) {
                const bit = bits[i];
                stat.innerText = `Bit ${i+1}/${bits.length}: ${bit}`;
                
                if(bit === '1') {
                    playTone(true); // Magnet ON
                } else {
                    playTone(false); // Magnet OFF
                }
                await wait(BIT_TIME);
            }

            playTone(false);
            stat.innerText = "COMPLETE";
            btn.disabled = false;
        }

        let osc = null;
        let gain = null;

        function playTone(on) {
            if(on) {
                if(osc) return; // Already running
                osc = audioCtx.createOscillator();
                gain = audioCtx.createGain();
                
                // Square wave creates sharper magnetic edges
                osc.type = 'square'; 
                osc.frequency.setValueAtTime(FREQ_LOW, audioCtx.currentTime);
                
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start();
            } else {
                if(osc) {
                    osc.stop();
                    osc.disconnect();
                    osc = null;
                }
            }
        }

        // --- RECEIVER (Compass API) ---
        const canvas = document.getElementById('scope');
        const ctx = canvas.getContext('2d');
        const needle = document.getElementById('needle');
        const rxLog = document.getElementById('rx-log');
        const rxDebug = document.getElementById('rx-debug');

        let isReading = false;
        let history = new Array(100).fill(0);
        let baseHeading = 0; // The "Normal" North

        // Logic
        let bitBuffer = "";
        let signalStart = 0;
        
        // We look for Variance (Jitter)
        // When the magnet is pulsing at 20Hz, the compass value goes crazy (high variance)
        // When silent, the compass is stable (low variance)

        function draw() {
            if(!isReading) return;
            
            ctx.fillStyle = '#00111f';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            ctx.strokeStyle = '#00d2ff';
            
            const step = canvas.width / history.length;
            for(let i=0; i<history.length; i++) {
                const val = history[i]; // Variance value
                const y = canvas.height - (val * 10); // Scale up
                if(i===0) ctx.moveTo(0, y);
                else ctx.lineTo(i*step, y);
            }
            ctx.stroke();
            requestAnimationFrame(draw);
        }

        function reqPerms() {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(r => { if (r == 'granted') startRx(); })
                    .catch(alert);
            } else { startRx(); }
        }

        function startRx() {
            document.getElementById('perm-btn').style.display = 'none';
            isReading = true;
            window.addEventListener('deviceorientation', handleOrient);
            
            // Start Sampling Loop (Decoupled from event rate)
            setInterval(processSignal, BIT_TIME); 
            draw();
        }

        let recentReadings = [];

        function handleOrient(e) {
            // e.alpha is the compass heading (0-360) 

[Image of compass rose]

            // We just need the raw value to detect jitter
            if(e.alpha !== null) {
                recentReadings.push(e.alpha);
                
                // Visual Needle (Smoothed)
                needle.style.transform = `rotate(${e.alpha}deg)`;
            }
        }

        function processSignal() {
            if(recentReadings.length < 2) return;

            // 1. Calculate Standard Deviation (Jitter) of recent readings
            // If the speaker is blasting 20Hz magnetic flux, this will be HIGH.
            // If silent, this will be LOW.
            
            let sum = 0;
            for(let v of recentReadings) sum += v;
            const avg = sum / recentReadings.length;
            
            let sqDiff = 0;
            for(let v of recentReadings) sqDiff += (v - avg) ** 2;
            const variance = Math.sqrt(sqDiff / recentReadings.length);
            
            // Clear buffer for next sample
            recentReadings = [];

            // Graphing
            history.push(variance);
            history.shift();

            // Threshold Logic
            // A variance > 0.5 usually means magnetic interference
            const THRESH = 0.5;
            
            const bit = variance > THRESH ? "1" : "0";
            
            rxDebug.innerText = `Flux Variance: ${variance.toFixed(2)} | Bit: ${bit}`;
            rxDebug.style.color = bit === "1" ? "#fff" : "#447788";

            // Decode Stream
            bitBuffer += bit;
            
            // Simple byte framing
            if(bitBuffer.length >= 8) {
                // Check if it looks like a valid char (simple filter)
                // This is a naive decoder (assumes perfect sync). 
                // In reality, you'd implement a Start Bit logic.
                // For this demo, we just dump chars.
                const byte = bitBuffer.substring(0,8);
                const val = parseInt(byte, 2);
                if(val >= 32 && val <= 126) {
                     rxLog.innerText += String.fromCharCode(val);
                }
                bitBuffer = bitBuffer.substring(8); // Shift
            }
        }

    </script>
</body>
</html>
