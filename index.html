<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Project QA: Silent & Deep</title>
    <style>
        :root { 
            --primary: #0A84FF; 
            --accent: #30D158;
            --danger: #FF453A;
            --bg: #000000; 
            --card-bg: #1C1C1E;
            --text: #F2F2F7;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
            transition: background-color 0.8s ease;
        }

        /* Responsive Layout Grid */
        .grid-wrapper {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            width: 100%;
            max-width: 500px; /* Default Mobile Width */
        }

        /* Laptop View (Side-by-Side) */
        @media (min-width: 800px) {
            .grid-wrapper {
                grid-template-columns: 1fr 1fr;
                max-width: 900px;
                align-items: start;
            }
            h1 { grid-column: span 2; }
        }

        h1 { 
            text-align: center; 
            margin-bottom: 20px; 
            font-size: 1.8rem; 
            font-weight: 700;
            letter-spacing: -0.5px;
            background: -webkit-linear-gradient(45deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Glassmorphism Cards */
        .card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 22px;
            border: 1px solid #333;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .section-title {
            text-transform: uppercase;
            font-size: 0.7rem;
            font-weight: 600;
            color: #666;
            letter-spacing: 1.2px;
            margin-bottom: 5px;
        }

        /* INPUTS & CONTROLS */
        input[type="color"] { 
            border: none; 
            width: 100%; 
            height: 80px; 
            cursor: pointer; 
            background: none; 
            border-radius: 12px;
        }

        .slider-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #888;
        }
        input[type="range"] { flex-grow: 1; margin: 0 15px; accent-color: var(--primary); }

        /* BUTTONS */
        button {
            width: 100%;
            padding: 16px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
            color: white;
        }
        button:active { transform: scale(0.98); }
        
        .btn-primary { background-color: var(--primary); }
        .btn-success { background-color: var(--accent); color: black; }
        .btn-danger { background-color: #2c2c2e; color: var(--danger); border: 1px solid #444; margin-top: 10px; }
        
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* VISUALIZERS */
        #rx-status {
            font-family: 'SF Mono', 'Courier New', monospace;
            font-size: 0.9rem;
            color: var(--accent);
            text-align: center;
            min-height: 20px;
        }

        .meter-container {
            height: 6px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
        }
        .meter-fill {
            height: 100%;
            width: 0%;
            background: var(--accent);
            transition: width 0.1s linear;
        }

    </style>
</head>
<body>

    <div class="grid-wrapper">
        <h1>Project QA <span style="font-size:0.5em; opacity:0.5; vertical-align:middle">ULTIMATE v2</span></h1>

        <div class="card">
            <div class="section-title">Transmitter</div>
            
            <input type="color" id="colorPicker" value="#00FF00">
            
            <div class="slider-group">
                <span>Vol</span>
                <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="0.8">
                <span id="volDisp">80%</span>
            </div>

            <button id="broadcastBtn" class="btn-primary">Broadcast Data</button>
            
            <div style="font-size:0.75rem; color:#555; text-align:center; margin-top:5px;">
                Freq: 17.5kHz - 19.5kHz (Silent)
            </div>
        </div>

        <div class="card">
            <div class="section-title">Receiver</div>
            
            <button id="listenBtn" class="btn-success">Start Receiver</button>
            
            <div id="rx-status">Status: Idle</div>
            
            <div>
                <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#666;">
                    <span>SIGNAL STRENGTH</span>
                    <span id="freq-readout">0 Hz</span>
                </div>
                <div class="meter-container">
                    <div id="signal-bar" class="meter-fill"></div>
                </div>
            </div>

            <hr style="border:0; border-top:1px solid #333; width:100%; margin:10px 0;">

            <div class="section-title" style="color:#FF453A;">Maintenance</div>
            <button id="purgeBtn" class="btn-danger">
                ðŸ”Š Sub-Bass Purge
            </button>
            <div style="font-size:0.7rem; color:#666; text-align:center;">
                Uses 55Hz vibration to clear dust/water.
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const FREQ_MIN = 17500; 
        const FREQ_MAX = 19500; 
        const FREQ_SYNC = 16500;
        
        // TIMINGS (Optimized for robustness)
        const T_SYNC = 0.8; 
        const T_DATA = 1.0; 
        const T_GAP = 0.2; 

        // --- AUDIO CONTEXT ---
        let audioCtx; // Shared Context
        
        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            return audioCtx;
        }

        // --- TRANSMITTER ---
        const btnTx = document.getElementById('broadcastBtn');
        const volSlider = document.getElementById('volumeSlider');
        
        volSlider.addEventListener('input', e => document.getElementById('volDisp').innerText = Math.round(e.target.value*100) + "%");

        btnTx.addEventListener('click', () => {
            initAudio();
            const rgb = hexToRgb(document.getElementById('colorPicker').value);
            const vol = parseFloat(volSlider.value);
            
            btnTx.disabled = true;
            btnTx.innerText = "Transmitting...";
            
            const t0 = audioCtx.currentTime + 0.1;
            
            // 1. Sync
            playTone(FREQ_SYNC, t0, T_SYNC, vol);

            // 2. Data
            let t = t0 + T_SYNC + T_GAP;
            rgb.forEach(val => {
                playTone(valToFreq(val), t, T_DATA, vol);
                t += T_DATA + T_GAP;
            });

            setTimeout(() => {
                btnTx.disabled = false;
                btnTx.innerText = "Broadcast Data";
            }, (t - t0) * 1000 + 200);
        });

        function playTone(freq, t, dur, vol) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.value = freq;
            osc.type = 'sine';
            
            gain.gain.setValueAtTime(0, t);
            gain.gain.linearRampToValueAtTime(vol, t + 0.1);
            gain.gain.setValueAtTime(vol, t + dur - 0.1);
            gain.gain.linearRampToValueAtTime(0, t + dur);

            osc.connect(gain).connect(audioCtx.destination);
            osc.start(t);
            osc.stop(t + dur);
        }

        // --- RECEIVER ---
        let analyser, mic;
        let isRunning = false;
        let rxState = 'IDLE'; 
        
        const btnRx = document.getElementById('listenBtn');
        const status = document.getElementById('rx-status');
        const bar = document.getElementById('signal-bar');
        const freqDisp = document.getElementById('freq-readout');

        btnRx.addEventListener('click', async () => {
            try {
                initAudio();
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 4096;
                analyser.smoothingTimeConstant = 0.2;

                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false }
                });
                
                mic = audioCtx.createMediaStreamSource(stream);
                mic.connect(analyser);
                
                isRunning = true;
                btnRx.style.display = 'none';
                status.innerText = "Listening...";
                loop();
            } catch(e) { alert("Mic Access Required: " + e.message); }
        });

        function loop() {
            if(!isRunning) return;
            requestAnimationFrame(loop);
            
            const data = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(data);
            
            // Analyze high freq range
            let maxVal = 0, maxIdx = 0;
            const startBin = Math.floor(15000 / (audioCtx.sampleRate / analyser.fftSize));
            
            for(let i = startBin; i < data.length; i++) {
                if(data[i] > maxVal) { maxVal = data[i]; maxIdx = i; }
            }

            // UI Updates
            const db = maxVal; 
            const domFreq = maxIdx * (audioCtx.sampleRate / analyser.fftSize);
            
            bar.style.width = (db/255)*100 + "%";
            bar.style.background = db > 50 ? "var(--accent)" : "var(--danger)";
            if(db > 40) freqDisp.innerText = Math.round(domFreq) + " Hz";

            // Logic
            if(rxState === 'IDLE' && db > 50) {
                if(Math.abs(domFreq - FREQ_SYNC) < 150) {
                    rxState = 'SYNCED';
                    status.innerText = "Sync Detected...";
                    status.style.color = "#FFD60A";
                    
                    // Trigger sampling logic
                    let startDelay = (T_SYNC + T_GAP + (T_DATA/2)) * 1000;
                    let step = (T_DATA + T_GAP) * 1000;
                    let colors = [0,0,0];

                    setTimeout(() => sampleBurst(0, colors), startDelay);
                    setTimeout(() => sampleBurst(1, colors), startDelay + step);
                    setTimeout(() => sampleBurst(2, colors), startDelay + step*2);
                }
            }
        }

        function sampleBurst(idx, results) {
            let samples = [];
            let count = 0;
            const labels = ["Red", "Green", "Blue"];
            status.innerText = `Scanning ${labels[idx]}...`;
            
            // Median Filter: 7 samples over 350ms
            let t = setInterval(() => {
                // Get current dominant freq again
                const data = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(data);
                let mV=0, mI=0; 
                const sB = Math.floor(15000 / (audioCtx.sampleRate / analyser.fftSize));
                for(let i=sB; i<data.length; i++) if(data[i]>mV) {mV=data[i]; mI=i;}
                
                if(mV > 30) samples.push(mI * (audioCtx.sampleRate / analyser.fftSize));
                
                count++;
                if(count >= 7) {
                    clearInterval(t);
                    if(samples.length > 0) {
                        samples.sort((a,b)=>a-b);
                        results[idx] = freqToVal(samples[Math.floor(samples.length/2)]);
                    } else results[idx] = 0;

                    if(idx === 2) finish(results);
                }
            }, 50);
        }

        function finish(rgb) {
            let [r,g,b] = rgb;
            let col = `rgb(${r},${g},${b})`;
            
            document.body.style.backgroundColor = col;
            
            // Check brightness for text contrast
            let lum = (0.299*r + 0.587*g + 0.114*b);
            document.body.style.color = lum > 128 ? '#000' : '#fff';
            status.innerText = `RECEIVED: ${col}`;
            
            setTimeout(() => {
                rxState = 'IDLE';
                document.body.style.backgroundColor = "var(--bg)";
                document.body.style.color = "var(--text)";
                status.innerText = "Listening...";
                status.style.color = "var(--accent)";
            }, 4000);
        }

        // --- SPEAKER PURGE (OPTIMIZED) ---
        const btnPurge = document.getElementById('purgeBtn');
        
        btnPurge.addEventListener('click', () => {
            initAudio();
            btnPurge.disabled = true;
            btnPurge.innerText = "PURGING...";
            
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            // SINE WAVE = Smooth, deep bass (not buzzy)
            osc.type = 'sine';
            
            // Use high gain for physical movement, but the low freq makes it quiet
            gain.gain.setValueAtTime(1.0, audioCtx.currentTime);
            
            osc.connect(gain).connect(audioCtx.destination);
            
            const t = audioCtx.currentTime;
            osc.start(t);
            
            // Create "Bass Drop" pulses (60Hz -> 40Hz)
            // This sweep ensures we hit the resonant frequency of the speaker
            for(let i=0; i<6; i++) {
                // Pulse On
                gain.gain.setValueAtTime(1, t + i*0.6);
                osc.frequency.setValueAtTime(60, t + i*0.6);
                osc.frequency.linearRampToValueAtTime(40, t + i*0.6 + 0.4); // Drop pitch
                
                // Pulse Off
                gain.gain.setValueAtTime(0, t + i*0.6 + 0.4); 
            }
            
            osc.stop(t + 3.6);
            
            setTimeout(() => {
                btnPurge.disabled = false;
                btnPurge.innerText = "ðŸ”Š Sub-Bass Purge";
            }, 3600);
        });

        // --- MATH HELPERS ---
        const valToFreq = v => FREQ_MIN + (v * ((FREQ_MAX - FREQ_MIN) / 255));
        const freqToVal = f => {
            if (f < FREQ_MIN) f = FREQ_MIN; if (f > FREQ_MAX) f = FREQ_MAX;
            return Math.round((f - FREQ_MIN) * (255 / (FREQ_MAX - FREQ_MIN)));
        };
        const hexToRgb = h => {
            const n = parseInt(h.substring(1), 16);
            return [(n >> 16) & 255, (n >> 8) & 255, n & 255];
        };
    </script>
</body>
</html>
