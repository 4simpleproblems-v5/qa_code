<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Project Seismic</title>
    <style>
        :root { --bg: #0d1117; --panel: #161b22; --accent: #ff7b72; --text: #c9d1d9; }
        body {
            background-color: var(--bg); color: var(--text);
            font-family: 'Courier New', monospace; margin: 0;
            display: flex; flex-direction: column; height: 100vh;
            overflow: hidden; -webkit-user-select: none;
        }

        /* NAVIGATION */
        .nav { display: flex; height: 60px; border-bottom: 1px solid #30363d; }
        .nav-item {
            flex: 1; display: flex; align-items: center; justify-content: center;
            background: #21262d; cursor: pointer; font-weight: bold; font-size: 1.1rem;
        }
        .nav-item.active { background: var(--panel); color: var(--accent); border-bottom: 4px solid var(--accent); }

        .screen { display: none; flex: 1; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .screen.active { display: flex; }

        /* TRANSMITTER UI */
        #vib-btn {
            width: 200px; height: 200px; border-radius: 50%;
            background: #21262d; border: 4px solid #30363d;
            color: #8b949e; font-size: 1.2rem; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.1s;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        #vib-btn:active, #vib-btn.active {
            background: var(--accent); color: #000;
            transform: scale(0.95); box-shadow: 0 0 50px var(--accent);
        }

        input {
            width: 80%; padding: 15px; margin-top: 30px;
            background: #0d1117; border: 1px solid #30363d; color: #fff;
            border-radius: 8px; font-family: monospace; text-align: center;
        }

        /* RECEIVER UI */
        #seismo-box {
            position: relative; width: 100%; max-width: 400px; height: 200px;
            background: #000; border: 2px solid #30363d; margin-bottom: 20px;
            overflow: hidden;
        }
        #seismograph { width: 100%; height: 100%; }
        
        .status-row { display: flex; gap: 20px; font-size: 0.8rem; color: #8b949e; margin-bottom: 10px; }
        
        #rx-msg { 
            font-size: 2rem; color: var(--accent); min-height: 3rem; 
            text-shadow: 0 0 10px rgba(255,123,114,0.5);
        }

        button.action {
            padding: 15px 40px; background: var(--accent); color: #000;
            border: none; border-radius: 8px; font-weight: bold; font-size: 1rem;
        }

    </style>
</head>
<body>

    <div class="nav">
        <div class="nav-item active" onclick="setTab('tx')">LAPTOP (TX)</div>
        <div class="nav-item" onclick="setTab('rx')">PHONE (RX)</div>
    </div>

    <div id="tx-screen" class="screen active">
        <div id="vib-btn" onmousedown="manualPulse(true)" onmouseup="manualPulse(false)">
            HOLD TO<br>RUMBLE
        </div>
        
        <input type="text" id="msg-input" placeholder="SECRET MSG" maxlength="8">
        <button class="action" onclick="transmitData()" style="margin-top:10px; width:80%;">SEND DATA</button>
        
        <p style="font-size:0.8rem; color:#666; margin-top:30px; max-width:300px; text-align:center;">
            Set Volume to 100%.<br>Place iPhone on laptop palm rest.
        </p>
    </div>

    <div id="rx-screen" class="screen">
        <button id="sensor-btn" class="action" onclick="startSensor()">ENABLE SENSORS</button>
        
        <div class="status-row">
            <span id="force-val">FORCE: 0.00</span>
            <span id="thresh-val">THR: 0.00</span>
        </div>

        <div id="seismo-box">
            <canvas id="seismograph"></canvas>
            <div id="thresh-line" style="position:absolute; bottom:20%; width:100%; height:1px; background:#00f; opacity:0.5;"></div>
        </div>

        <div id="rx-msg">WAITING...</div>
        <div style="font-size:0.7rem; color:#444;">Keep phone still flat on surface</div>
    </div>

    <script>
        // --- CONFIG ---
        const BIT_TIME = 400; // 400ms (Mechanical vibration takes time to stop)
        const FREQ = 55;      // 55Hz (Resonant freq for most plastic chassis)
        
        // --- TABS ---
        function setTab(t) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(t+'-screen').classList.add('active');
            event.target.classList.add('active');
        }

        // --- TRANSMITTER (AUDIO) ---
        let audioCtx;
        let osc;

        function initAudio() {
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if(audioCtx.state === 'suspended') audioCtx.resume();
        }

        function manualPulse(on) {
            const btn = document.getElementById('vib-btn');
            if(on) {
                btn.classList.add('active');
                startTone();
            } else {
                btn.classList.remove('active');
                stopTone();
            }
        }

        function startTone() {
            initAudio();
            if(osc) stopTone();
            osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            // SQUARE wave creates the most physical movement (jerk)
            osc.type = 'square'; 
            osc.frequency.value = FREQ;
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
        }

        function stopTone() {
            if(osc) {
                osc.stop();
                osc.disconnect();
                osc = null;
            }
        }

        async function transmitData() {
            const text = document.getElementById('msg-input').value.toUpperCase();
            if(!text) return;
            
            // Convert to Binary
            let bits = "";
            for(let i=0; i<text.length; i++) {
                bits += text.charCodeAt(i).toString(2).padStart(8, "0");
            }

            // 1. HEADER (Wake up shake)
            manualPulse(true); await wait(BIT_TIME);
            manualPulse(false); await wait(BIT_TIME);
            manualPulse(true); await wait(BIT_TIME);
            manualPulse(false); await wait(BIT_TIME * 2);

            // 2. DATA
            for(let i=0; i<bits.length; i++) {
                const on = bits[i] === "1";
                if(on) startTone();
                else stopTone();
                
                // Visual feedback
                const btn = document.getElementById('vib-btn');
                if(on) btn.classList.add('active'); else btn.classList.remove('active');

                await wait(BIT_TIME);
            }

            stopTone();
            document.getElementById('vib-btn').classList.remove('active');
        }
        const wait = ms => new Promise(r => setTimeout(r, ms));


        // --- RECEIVER (ACCELEROMETER) ---
        let rxRunning = false;
        let lastZ = 0;
        let history = new Array(100).fill(0);
        
        const canvas = document.getElementById('seismograph');
        const ctx = canvas.getContext('2d');
        
        // Decoding Logic
        let state = "SEARCH";
        let bitBuf = "";
        let nextSample = 0;
        let threshold = 0.5; // Sensitivity (Auto-adjusts)

        function startSensor() {
            // iOS 13+ Permission Request
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') initMotion();
                        else alert('Permission denied');
                    })
                    .catch(console.error);
            } else {
                // Non-iOS or older devices
                initMotion();
            }
        }

        function initMotion() {
            window.addEventListener('devicemotion', handleMotion);
            document.getElementById('sensor-btn').style.display = 'none';
            rxRunning = true;
            resizeCanvas();
            drawLoop();
        }

        function handleMotion(event) {
            // We only care about Z-axis (Up/Down vibration)
            // We verify accelerationIncludingGravity to detect shake
            const z = event.acceleration.z || event.accelerationIncludingGravity.z;
            
            // Calculate "Jerk" (Change in acceleration) to ignore gravity/tilt
            const delta = Math.abs(z - lastZ);
            lastZ = z;

            // Push to history for graph
            history.push(delta);
            history.shift();
            
            // UI Update
            document.getElementById('force-val').innerText = "FORCE: " + delta.toFixed(2);
        }

        function drawLoop() {
            if(!rxRunning) return;
            requestAnimationFrame(drawLoop);

            // 1. Draw Graph
            ctx.fillStyle = "#000"; ctx.fillRect(0,0,canvas.width, canvas.height);
            ctx.beginPath();
            ctx.strokeStyle = "#ff7b72"; ctx.lineWidth = 2;
            
            const h = canvas.height;
            // Scale factor: A delta of 2.0 is a HUGE shake
            const scale = h / 2; 

            for(let i=0; i<history.length; i++) {
                const x = (i / history.length) * canvas.width;
                const y = h - (history[i] * scale);
                if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
            }
            ctx.stroke();

            // 2. Logic (Sample the average of the last 10 frames)
            const recentAvg = history.slice(-10).reduce((a,b)=>a+b,0)/10;
            const isShaking = recentAvg > 0.3; // 0.3 is a good baseline threshold

            // Draw Threshold Line
            const thY = h - (0.3 * scale);
            ctx.beginPath(); ctx.strokeStyle = "#00f"; 
            ctx.moveTo(0, thY); ctx.lineTo(canvas.width, thY); ctx.stroke();

            const now = Date.now();

            if(state === "SEARCH") {
                // Look for the header (Sustained shake)
                if(isShaking) {
                    // Start logic
                    state = "READ";
                    nextSample = now + BIT_TIME * 1.5;
                    bitBuf = "";
                    document.getElementById('rx-msg').innerText = "RUMBLE DETECTED";
                }
            }
            else if (state === "READ") {
                if(now >= nextSample) {
                    nextSample += BIT_TIME;
                    bitBuf += isShaking ? "1" : "0";
                    
                    if(bitBuf.length === 8) {
                        const char = String.fromCharCode(parseInt(bitBuf, 2));
                        const disp = document.getElementById('rx-msg');
                        if(disp.innerText.includes("RUMBLE")) disp.innerText = "";
                        disp.innerText += char;
                        bitBuf = "";
                        
                        // Vibration feedback on phone to confirm receipt
                        if(navigator.vibrate) navigator.vibrate(50);
                    }
                }
                if(now > nextSample + 3000) state = "SEARCH";
            }
        }

        function resizeCanvas() {
            canvas.width = document.getElementById('seismo-box').clientWidth;
            canvas.height = document.getElementById('seismo-box').clientHeight;
        }
    </script>
</body>
</html>
