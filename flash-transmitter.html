<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Project Prism: Spectral Link</title>
    <style>
        :root { --bg: #000; --text: #fff; }
        body {
            background-color: var(--bg); color: var(--text);
            font-family: 'Courier New', monospace; margin: 0;
            display: flex; flex-direction: column; height: 100vh;
            overflow: hidden; -webkit-user-select: none;
        }

        /* NAV */
        .nav { display: flex; height: 50px; border-bottom: 1px solid #333; }
        .nav-item {
            flex: 1; display: flex; align-items: center; justify-content: center;
            background: #111; cursor: pointer; font-weight: bold; border-right: 1px solid #333;
        }
        .nav-item.active { background: #333; color: #fff; border-bottom: 2px solid #fff; }

        .view { display: none; flex: 1; flex-direction: column; align-items: center; padding: 20px; }
        .view.active { display: flex; }

        /* TRANSMITTER */
        #prism-box {
            width: 300px; height: 300px; margin-bottom: 20px;
            background: #000; border: 4px solid #fff;
            display: flex; align-items: center; justify-content: center;
            font-size: 2rem; font-weight: bold; color: #000;
            text-shadow: 0 0 5px rgba(255,255,255,0.5);
        }

        .controls { width: 100%; max-width: 300px; display: flex; flex-direction: column; gap: 10px; }
        input[type="text"] { 
            padding: 15px; background: #222; border: 1px solid #444; color: #fff; 
            text-align: center; font-family: monospace; font-size: 1.2rem;
        }
        button { 
            padding: 15px; border: none; border-radius: 4px; font-weight: bold; 
            cursor: pointer; background: #fff; color: #000; font-size: 1rem;
        }

        /* RECEIVER */
        #cam-container {
            position: relative; width: 300px; height: 300px;
            background: #000; border: 2px solid #555; overflow: hidden; margin-bottom: 10px;
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        #rx-log { 
            width: 300px; height: 60px; background: #111; border: 1px solid #333; 
            padding: 10px; color: #fff; font-size: 1.5rem; overflow-wrap: break-word;
        }
        
        .hue-bar {
            width: 300px; height: 20px; background: linear-gradient(to right, red, yellow, lime, cyan, blue, magenta, red);
            margin-bottom: 5px; position: relative;
        }
        #hue-cursor {
            position: absolute; top:0; left:0; width:4px; height:20px; background:#fff; border:1px solid #000;
        }

        .stat-row { width: 300px; display: flex; justify-content: space-between; font-size: 0.8rem; color: #888; }

    </style>
</head>
<body>

    <div class="nav">
        <div class="nav-item active" onclick="setView('tx')">PRISM (TX)</div>
        <div class="nav-item" onclick="setView('rx')">CAMERA (RX)</div>
    </div>

    <div id="tx-view" class="view active">
        <div id="prism-box">READY</div>

        <div class="controls">
            <input type="text" id="tx-input" value="RGB-DATA" placeholder="Message">
            <button id="tx-btn" onclick="transmit()">SEND (Base-8 Color)</button>
        </div>
        <div style="font-size:0.7rem; color:#666; margin-top:10px; text-align:center;">
            Uses Hue Shift Keying (HSK).<br>8 Colors = 3 bits per flash.
        </div>
    </div>

    <div id="rx-view" class="view">
        <button id="cam-btn" onclick="startRx()" style="width:300px; margin-bottom:15px;">START CAMERA</button>
        
        <div id="cam-container">
            <video id="video" autoplay playsinline muted></video>
            <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:50px; height:50px; border:3px solid #fff; border-radius:50%; box-shadow:0 0 0 100px rgba(0,0,0,0.8);"></div>
        </div>
        
        <div class="hue-bar"><div id="hue-cursor"></div></div>
        
        <div class="stat-row">
            <span id="state-lbl">State: IDLE</span>
            <span id="hue-lbl">Hue: 0°</span>
        </div>

        <div id="rx-log"></div>
    </div>

    <script>
        // --- CONFIG ---
        const FRAME_MS = 300; // 300ms per color chunk
        const PILOT_MS = 2000;

        // Color Map (Hue Values)
        // 0: Red (0°), 1: Orange (45°), 2: Yellow (60->90?), Let's space them evenly
        // Base-8 Map: 000->111
        // We divide 360 degrees by 8 = 45 degree steps
        // 0: 0° (Red)
        // 1: 45° (Orange/Yellow)
        // 2: 90° (Chartreuse)
        // 3: 135° (Green)
        // 4: 180° (Cyan)
        // 5: 225° (Blue)
        // 6: 270° (Purple)
        // 7: 315° (Magenta)
        
        const HUES = [0, 45, 90, 135, 180, 225, 270, 315];
        const COLORS = [
            'hsl(0,100%,50%)',   // 0
            'hsl(45,100%,50%)',  // 1
            'hsl(90,100%,50%)',  // 2
            'hsl(135,100%,50%)', // 3
            'hsl(180,100%,50%)', // 4
            'hsl(225,100%,50%)', // 5
            'hsl(270,100%,50%)', // 6
            'hsl(315,100%,50%)'  // 7
        ];

        function setView(v) {
            document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            document.getElementById(v+'-view').classList.add('active');
            event.target.classList.add('active');
        }

        // --- TRANSMITTER ---
        const box = document.getElementById('prism-box');
        
        async function transmit() {
            const text = document.getElementById('tx-input').value;
            const btn = document.getElementById('tx-btn');
            btn.disabled = true;

            // Convert to binary
            let bits = "";
            for(let i=0; i<text.length; i++) {
                bits += text.charCodeAt(i).toString(2).padStart(8, "0");
            }
            // Pad to multiple of 3 (Base-8 needs 3 bits per symbol)
            while(bits.length % 3 !== 0) bits += "0";

            // 1. PILOT (White)
            box.style.background = "#FFF";
            box.innerText = "PILOT";
            await wait(PILOT_MS);

            // 2. SYNC (Black Drop)
            box.style.background = "#000";
            box.innerText = "";
            await wait(FRAME_MS * 1.5);

            // 3. DATA (Octal)
            btn.innerText = "SENDING...";
            
            for(let i=0; i<bits.length; i+=3) {
                const chunk = bits.substring(i, i+3);
                const val = parseInt(chunk, 2);
                
                box.style.background = COLORS[val];
                box.innerText = val; // Debug number
                await wait(FRAME_MS);
            }

            box.style.background = "#000";
            btn.innerText = "SEND (Base-8)";
            btn.disabled = false;
        }
        const wait = ms => new Promise(r => setTimeout(r, ms));


        // --- RECEIVER ---
        let rxRunning = false;
        const vid = document.getElementById('video');
        const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d', { willReadFrequently: true });
        
        const log = document.getElementById('rx-log');
        const stateLbl = document.getElementById('state-lbl');
        const hueLbl = document.getElementById('hue-lbl');
        const cursor = document.getElementById('hue-cursor');

        let state = "SEARCH";
        let nextSample = 0;
        let bitBuffer = "";

        async function startRx() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                vid.srcObject = stream;
                vid.onloadedmetadata = () => vid.play();
                document.getElementById('cam-btn').style.display = 'none';
                rxRunning = true;
                loop();
            } catch(e) { alert("Cam Error: "+e); }
        }

        function loop() {
            if(!rxRunning) return;

            // 1. Read Center Pixel
            cvs.width=20; cvs.height=20;
            ctx.drawImage(vid, vid.videoWidth/2-10, vid.videoHeight/2-10, 20, 20, 0, 0, 20, 20);
            const d = ctx.getImageData(0,0,20,20).data;
            
            // Average RGB
            let r=0, g=0, b=0;
            for(let i=0; i<d.length; i+=4) { r+=d[i]; g+=d[i+1]; b+=d[i+2]; }
            r /= 400; g /= 400; b /= 400;

            // Convert to HSL (We only need Hue and Lightness)
            const hsl = rgbToHsl(r, g, b); // h [0-360], s [0-1], l [0-1]
            const h = hsl[0];
            const l = hsl[2];

            // UI Update
            cursor.style.left = (h / 360 * 300) + "px";
            hueLbl.innerText = `Hue: ${Math.round(h)}° L: ${Math.round(l*100)}%`;

            const now = Date.now();

            // 3. Logic
            if(state === "SEARCH") {
                stateLbl.innerText = "WAIT FOR PILOT (WHITE)";
                // White is Low Saturation, High Lightness
                // But simplified: Pilot is just super bright
                if(l > 0.8) state = "PILOT";
            }
            else if(state === "PILOT") {
                stateLbl.innerText = "LOCKED";
                stateLbl.style.color = "#FFD60A";
                // Wait for Drop (Black)
                if(l < 0.2) {
                    state = "READ";
                    // Sync: Align to center of next frame
                    // We wait Drop(black) + Half Frame
                    nextSample = now + (FRAME_MS * 1.5); 
                    bitBuffer = "";
                    log.innerText = "";
                    stateLbl.innerText = "RECEIVING";
                    stateLbl.style.color = "#00ff00";
                }
            }
            else if(state === "READ") {
                if(now >= nextSample) {
                    nextSample += FRAME_MS;
                    
                    // Decode Hue to Octal (0-7)
                    // We find the closest match in our HUES array
                    let closestDiff = 999;
                    let val = 0;
                    
                    for(let i=0; i<8; i++) {
                        // Handle circular wraparound (355 is close to 0)
                        let diff = Math.abs(h - HUES[i]);
                        if(diff > 180) diff = 360 - diff;
                        
                        if(diff < closestDiff) {
                            closestDiff = diff;
                            val = i;
                        }
                    }

                    // Append 3 bits
                    const bits = val.toString(2).padStart(3, "0");
                    bitBuffer += bits;

                    // Decode Bytes
                    while(bitBuffer.length >= 8) {
                        const byte = bitBuffer.substring(0, 8);
                        bitBuffer = bitBuffer.substring(8);
                        const charCode = parseInt(byte, 2);
                        if(charCode >= 32 && charCode <= 126) {
                            log.innerText += String.fromCharCode(charCode);
                        }
                    }
                }
                
                if(now > nextSample + 3000) state = "SEARCH";
            }

            requestAnimationFrame(loop);
        }

        // RGB to HSL helper
        function rgbToHsl(r, g, b) {
            r /= 255, g /= 255, b /= 255;
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;

            if (max === min) { h = s = 0; } 
            else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            return [h * 360, s, l];
        }

    </script>
</body>
</html>
